<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Captura de Im√≥vel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 2rem;
      text-align: center;
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 2rem;
      color: #333;
    }

    #photoInput {
      display: none;
    }

    label#btnCamera,
    label#btnGallery {
      display: inline-block;
      background-color: #007bff;
      color: #fff;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background 0.3s;
    }

    label#btnCamera.loading,
    label#btnGallery.loading {
      background-color: #555;
      cursor: not-allowed;
    }

    label#btnCamera.loading::after,
    label#btnGallery.loading::after {
      content: ' ‚è≥ Enviando...';
    }

    #status {
      margin-top: 1.5rem;
      font-size: 1rem;
    }

    #pwaPrompt {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #007bff;
      color: white;
      padding: 1rem;
      font-size: 1rem;
      text-align: center;
      z-index: 1000;
      display: none;
    }

    #pwaPrompt button {
      background: white;
      color: #007bff;
      border: none;
      padding: 0.5rem 1rem;
      margin-left: 1rem;
      border-radius: 5px;
      cursor: pointer;
    }

    #debugStatus {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #222;
      color: #0f0;
      font-size: 0.9rem;
      padding: 0.5rem;
      font-family: monospace;
      z-index: 9999;
      text-align: left;
      white-space: pre-wrap;
      max-height: 30vh;
      overflow-y: auto;
    }

    body::after {
      content: "";
      position: fixed;
      bottom: 0;
      right: 0;
      width: 512px;
      height: 512px;
      background-image: url('icon-512.png');
      background-repeat: no-repeat;
      background-size: contain;
      opacity: 0.2;
      pointer-events: none;
      z-index: 0;
    }



  </style>
  <link rel="manifest" href="/manifest_captura.json">
  <meta name="theme-color" content="#007bff">

</head>
<body>
  <div id="debugStatus" class="debugStatus" style="display:none;">[DEBUG]</div>
  
  <h1 style="padding-top: 200px;"><span onclick="javascript:mostrarDebug()">üì∏</span> Captura de Im√≥vel</h1>

  <input type="file" id="photoInputCamera" accept="image/*" capture="environment" style="display:none">
  <input type="file" id="photoInputGallery" accept="image/*" style="display:none">

  <label for="photoInputCamera" id="btnCamera">üì∏ Tirar Foto</label><hr>
  <label for="photoInputGallery" id="btnGallery">üñºÔ∏è Escolher do √Ålbum</label>


  <div id="status"></div>
  <button class="debugStatus" style="display:none;" onclick="verificarInstalabilidade()">üîç Verificar Instalabilidade</button>

  <script>
    let lat = null, lon = null;
    let watchId = null;
    let _gps=null;
    let deferredPrompt = null;

    function logDebug(msg) {
      const debugEl = document.getElementById("debugStatus");
      if (debugEl) {
        const time = new Date().toLocaleTimeString();
        const newMsg = `[${time}] ${msg}`;

        // Limita a 50 linhas no log para evitar congelamentos
        const linhas = debugEl.textContent.split("\n");
        if (linhas.length >= 50) {
          linhas.shift();
        }
        linhas.push(newMsg);
        debugEl.textContent = linhas.join("\n");
      }
    }

    function verificarInstalabilidade() {
      logDebug("üß™ Checando requisitos...");
      logDebug("Manifest presente: " + !!document.querySelector('link[rel="manifest"]'));
      logDebug("Display-mode standalone: " + window.matchMedia('(display-mode: standalone)').matches);
      logDebug("UserAgent: " + navigator.userAgent);
    }

    function mostrarDebug() {
      const debugEl = document.getElementsByClassName("debugStatus");
      if (!debugEl) return;
      let isHidden=false;
      Array.from(debugEl).forEach(element => {
        element.style.display = element.style.display === "none" ? "block" : "none";
        isHidden = element.style.display === "block";
      });
      logDebug(`üîç Debug ${isHidden ? "ativado" : "desativado"}`);
    }

    function iniciarGPS() {
      if (_gps) {
        clearTimeout(_gps);
        _gps = null;
      }

      if (!navigator.geolocation) {
        logDebug("‚ö†Ô∏è Navegador n√£o suporta GPS.");
        return;
      }

      logDebug("üìç Tentando obter localiza√ß√£o atual...");

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          lat = pos.coords.latitude;
          lon = pos.coords.longitude;
          logDebug(`üìç Localiza√ß√£o obtida: ${lat}, ${lon}`);
        },
        (err) => {
          logDebug(`‚ö†Ô∏è Erro ao obter localiza√ß√£o (modo r√°pido): ${err.message}`);

          // Fallback com watchPosition se o getCurrentPosition falhar
          const watchIdFallback = navigator.geolocation.watchPosition(
            (pos) => {
              lat = pos.coords.latitude;
              lon = pos.coords.longitude;
              logDebug(`üìç Localiza√ß√£o (fallback) obtida: ${lat}, ${lon}`);
              navigator.geolocation.clearWatch(watchIdFallback);
            },
            (err2) => {
              logDebug(`‚ùå Erro no fallback GPS: ${err2.message}`);
            },
            {
              enableHighAccuracy: true,
              maximumAge: 10000,
              timeout: 10000
            }
          );
        },
        {
          enableHighAccuracy: true,
          maximumAge: 8000,
          timeout: 10000 // aumentamos de 2000 ‚Üí 10000ms (10s)
        }
      );

      // Repeti√ß√£o autom√°tica para manter atualiza√ß√£o
      _gps = setTimeout(iniciarGPS, 15000); // executa a cada 15s
    }


    
    async function enviarFoto(file) {
      const statusText = document.getElementById("status");

      // Verifica qual bot√£o foi usado por √∫ltimo (btnCamera ou btnGallery)
      const botao = window._botaoUsado || document.getElementById("btnCamera");

      botao.classList.add("loading");
      statusText.textContent = "";
      iniciarGPS();

      const atualizarLocalizacaoEEnviar = () => {
        const formData = new FormData();
        formData.append("file", file);

        let url = "https://a4hcgqi5kupnvbo5rm22ben2le0xufqd.lambda-url.us-east-2.on.aws/";
        if (lat && lon) url += `?lat=${lat}&lon=${lon}`;
        else statusText.textContent = "‚ö†Ô∏è Localiza√ß√£o n√£o dispon√≠vel no momento. A foto ser√° enviada mesmo assim.";

        fetch(url, {
          method: "POST",
          body: formData
        })
          .then(res => res.json())
          .then(data => {
            logDebug(`üì¶ Resposta: ${JSON.stringify(data)}`);
            if (data && (data.status || data.numero_casa || data.telefones)) {
              statusText.textContent = "‚úÖ Foto processada com sucesso!";
            } else {
              statusText.textContent = "‚ö†Ô∏è Foto enviada, mas sem dados detectados.";
            }
            iniciarGPS();
            window.setTimeout(function(){
              statusText.textContent = "";
            },5000);
          })
          .catch(err => {
            logDebug("‚ùå Erro ao enviar:", err);
            statusText.textContent = "‚ùå Erro ao enviar. Tente novamente.";
          })
          .finally(() => {
            botao.classList.remove("loading");
            document.getElementById("photoInput").value = "";
          });
      };
      if (lat === null || lon === null) {
        logDebug("üîÑ Atualizando localiza√ß√£o antes de enviar...");
        iniciarGPS();
        window.setTimeout(atualizarLocalizacaoEEnviar, 3000); // espera 3 segundos para garantir que o GPS foi atualizado
      } else {
        atualizarLocalizacaoEEnviar();
      }
    }

    function isIOS() {
      return /iphone|ipad|ipod/i.test(navigator.userAgent);
    }

    function isInStandaloneMode() {
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
    }

    async function mostrarPromptInstalacao() {
      if (!deferredPrompt) {
        logDebug("‚ö†Ô∏è deferredPrompt ainda n√£o dispon√≠vel.");
        return;
      }

      try {
        await deferredPrompt.prompt();
        const escolha = await deferredPrompt.userChoice;

        logDebug(`üßæ Escolha do usu√°rio: ${escolha.outcome}`);

        if (escolha.outcome === 'accepted') {
          logDebug("‚úÖ App ser√° instalado");
        } else {
          logDebug("‚ùå Usu√°rio recusou a instala√ß√£o");
        }

        deferredPrompt = null;
      } catch (e) {
        logDebug("‚ùå Erro ao exibir prompt:", e);
      }
    }

    function fecharPrompt() {
      document.getElementById("pwaPrompt").style.display = "none";
      mostrarPromptInstalacao(); // chama o prompt aqui
    }

    // DEBUG opcional: bot√£o escondido para chamar for√ßadamente
    window.testarInstalacao = () => {
      logDebug("üöÄ Chamando prompt manual...");
      mostrarPromptInstalacao();
    };

    // Instala√ß√£o PWA Android
    window.addEventListener("beforeinstallprompt", (e) => {
      logDebug("‚úÖ Evento beforeinstallprompt capturado");
      e.preventDefault();
      deferredPrompt = e;

      if (!window.matchMedia('(display-mode: standalone)').matches) {
        document.getElementById("pwaPrompt").style.display = "block";
      }
    });

    // DOM Ready
    document.addEventListener("DOMContentLoaded", () => {
      // Marcar qual bot√£o foi clicado para aplicar a anima√ß√£o de loading correta
      document.getElementById("btnCamera").addEventListener("click", () => {
        window._botaoUsado = document.getElementById("btnCamera");
      });
      document.getElementById("btnGallery").addEventListener("click", () => {
        window._botaoUsado = document.getElementById("btnGallery");
      });

      ["photoInputCamera", "photoInputGallery"].forEach((id) => {
        const input = document.getElementById(id);

        input.addEventListener("change", () => {
          const file = input.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = function (e) {
            const img = new Image();
            img.onload = function () {
              const canvas = document.createElement("canvas");
              const MAX_DIM = 1600;

              let width = img.width;
              let height = img.height;

              if (width > height) {
                if (width > MAX_DIM) {
                  height *= MAX_DIM / width;
                  width = MAX_DIM;
                }
              } else {
                if (height > MAX_DIM) {
                  width *= MAX_DIM / height;
                  height = MAX_DIM;
                }
              }

              canvas.width = width;
              canvas.height = height;

              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, width, height);

              canvas.toBlob((blob) => {
                if (blob) {
                  const compressedFile = new File([blob], file.name, { type: "image/jpeg" });
                  enviarFoto(compressedFile);
                } else {
                  logDebug("‚ùå Falha ao comprimir imagem.");
                }
              }, "image/jpeg", 0.8);
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      });

      iniciarGPS();


      // Sugest√£o para iOS
      if (isIOS() && !isInStandaloneMode()) {
        const pwaPrompt = document.getElementById("pwaPrompt");
        pwaPrompt.innerHTML = `
          üì± Para instalar este app:<br>
          1. Toque no bot√£o <strong>‚ÄúCompartilhar‚Äù</strong> (√≠cone com seta pra cima)<br>
          2. Escolha <strong>‚ÄúAdicionar √† Tela de In√≠cio‚Äù</strong>
        `;
        pwaPrompt.style.display = "block";
      }
  
    });

  </script>

  <div id="pwaPrompt">
    üì± Adicionar √† tela inicial
    <button onclick="fecharPrompt()">OK</button>
  </div>


</body>
</html>
